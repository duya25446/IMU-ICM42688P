# BMM350中断模式使用说明

## 🎯 实现概述

BMM350磁力计现已支持**中断驱动模式**，参考ICM42688P的EXTI0实现方式，使用PB9外部中断实现高效的数据采集。

## 📊 中断模式 vs 轮询模式对比

| 特性 | 中断模式 | 轮询模式 |
|------|---------|---------|
| CPU占用 | **极低**（仅中断时处理） | 高（持续查询状态） |
| 实时性 | **优秀**（硬件触发） | 良好（软件轮询） |
| 代码复杂度 | 稍高 | 简单 |
| 资源占用 | RAM 4088B, Flash 68964B | RAM 4288B, Flash 69076B |
| 适用场景 | **推荐**，400Hz高速采集 | 调试验证 |

## 🔧 中断流程

```
BMM350数据就绪 
    ↓
INT引脚产生上升沿脉冲 (PB9)
    ↓
触发EXTI9_5中断
    ↓
EXTI9_5_IRQHandler()
    ↓
BMM350_Interrupt_Handle()
    ├─ 读取补偿后的磁场数据
    ├─ 存储到bmm350_latest_data
    └─ 设置bmm350_data_ready_flag
    ↓
主循环调用BMM350_Demo_Get_Latest_Data()
    ├─ 检查bmm350_data_ready_flag
    ├─ 复制数据
    ├─ 清除标志
    └─ 格式化并通过UART2输出
```

## 💻 代码实现

### 1. 中断服务程序 (`Core/Src/stm32g4xx_it.c`)

```c
void EXTI9_5_IRQHandler(void)
{
  HAL_GPIO_EXTI_IRQHandler(GPIO_PIN_9);
  
  // BMM350磁力计数据就绪中断处理
  extern void BMM350_Interrupt_Handle(void);
  BMM350_Interrupt_Handle();
}
```

### 2. 中断处理函数 (`Core/Src/BMM350/BMM350_Demo.c`)

```c
// 全局变量
static struct bmm350_mag_temp_data bmm350_latest_data;  // 数据缓冲区
static volatile uint8_t bmm350_data_ready_flag = 0;     // 就绪标志

// 中断处理函数（在中断中调用）
void BMM350_Interrupt_Handle(void)
{
    int8_t rslt;
    
    // 读取补偿后的磁场数据到缓冲区
    rslt = BMM350_Get_Compensated_Data(&bmm350_latest_data);
    
    if (rslt == BMM350_OK) {
        // 设置数据就绪标志
        bmm350_data_ready_flag = 1;
    }
}

// 获取最新数据（在主循环中调用）
uint8_t BMM350_Demo_Get_Latest_Data(struct bmm350_mag_temp_data *mag_data)
{
    if (bmm350_data_ready_flag) {
        // 复制数据
        *mag_data = bmm350_latest_data;
        
        // 清除标志
        bmm350_data_ready_flag = 0;
        
        return 1;  // 有新数据
    }
    
    return 0;  // 无新数据
}
```

### 3. 主循环 (`Core/Src/main.c`)

```c
while (1)
{
    // 中断模式：检查是否有新数据
    struct bmm350_mag_temp_data bmm350_mag_data;
    if (BMM350_Demo_Get_Latest_Data(&bmm350_mag_data)) {
        // 格式化并输出数据
        sprintf(buffer, "MAG:%.2f,%.2f,%.2f,%.2f,%lu\r\n",
               bmm350_mag_data.x,
               bmm350_mag_data.y,
               bmm350_mag_data.z,
               bmm350_mag_data.temperature,
               HAL_GetTick());
        
        HAL_UART_Transmit(&huart2, buffer, strlen(buffer), 100);
    }
}
```

## ⚙️ 硬件配置

### PB9外部中断配置
- **触发方式**: 上升沿触发
- **中断优先级**: 0（最高）
- **上拉/下拉**: 无（NOPULL）
- **中断向量**: EXTI9_5_IRQn

### BMM350 INT引脚配置
- **模式**: Push-Pull（推挽输出）
- **极性**: Active High（高电平有效）
- **脉冲模式**: Pulsed（脉冲触发，非锁存）
- **映射**: 已映射到INT引脚（PB9）

## 📈 性能优势

### 中断模式的优势

1. **低CPU占用**：
   - 主循环无需持续查询状态寄存器
   - 仅在数据就绪时处理（400Hz，每2.5ms一次）
   - CPU可用于其他任务

2. **高实时性**：
   - 硬件触发，无延迟
   - 数据就绪后立即响应（<1μs）
   - 避免数据丢失

3. **节省资源**：
   - RAM减少200B（4088 vs 4288）
   - Flash减少112B（68964 vs 69076）
   - 更低的I2C总线占用

## 🔄 轮询模式 vs 中断模式切换

### 使用中断模式（推荐）

主循环代码（当前配置）：
```c
// 中断模式
struct bmm350_mag_temp_data bmm350_mag_data;
if (BMM350_Demo_Get_Latest_Data(&bmm350_mag_data)) {
    // 输出数据
}
```

### 使用轮询模式

如需切换回轮询模式，修改主循环：
```c
// 轮询模式
BMM350_Demo_Loop();
```

并修改驱动层初始化，将中断映射改为：
```c
bmm350_configure_interrupt(BMM350_PULSED,
                          BMM350_ACTIVE_HIGH,
                          BMM350_INTR_PUSH_PULL,
                          BMM350_UNMAP_FROM_PIN,  // ← 改为不映射
                          &bmm350_dev);
```

## 🧪 测试验证

### 预期行为

1. **初始化**：
   ```
   [BMM350] 配置数据就绪中断（映射到INT引脚PB9）
   ```

2. **运行时**：
   - PB9每2.5ms产生一次上升沿脉冲
   - 触发EXTI9_5中断
   - 中断中读取磁场数据
   - 主循环输出数据

3. **数据输出**：
   ```
   MAG:20.45,-15.32,42.18,25.30,1000
   MAG:20.48,-15.28,42.20,25.31,1003  ← 间隔2.5ms
   MAG:20.50,-15.30,42.22,25.30,1005
   ```

### 示波器测试（可选）

在PB9引脚上可观察到：
- **频率**: 400Hz（2.5ms周期）
- **脉冲宽度**: 约1.25ms（PULSED模式）
- **电平**: 高电平脉冲（Active High）

## 🐛 故障排查

### 问题：无中断触发

**现象**：串口无数据输出

**排查步骤**：
1. 检查PB9是否正确连接到BMM350的INT引脚
2. 用万用表测量PB9电平（应该有脉冲）
3. 检查EXTI9_5中断是否使能：
   ```c
   HAL_NVIC_EnableIRQ(EXTI9_5_IRQn);  // 应在GPIO_Init中
   ```
4. 在中断处理函数中添加LED翻转验证中断触发

### 问题：中断频率不对

**现象**：数据更新频率不是400Hz

**可能原因**：
- ODR设置错误
- AVG设置与ODR不兼容
- 传感器未进入Normal Mode

**解决**：
- 检查初始化输出：`[BMM350] 配置: ODR=400Hz, AVG=8`
- 确认进入Normal Mode：`[BMM350] 已切换到Normal Mode`

### 问题：数据重复

**现象**：连续多次输出相同数据

**原因**：中断触发速度快于主循环输出速度

**解决**：
- 使用DMA方式发送UART数据
- 或在中断中直接发送（不推荐，占用中断时间）

## 📝 API接口总结

### 中断模式专用接口

```c
// 在EXTI9_5中断中调用
void BMM350_Interrupt_Handle(void);

// 在主循环中调用，获取中断中读取的数据
uint8_t BMM350_Demo_Get_Latest_Data(struct bmm350_mag_temp_data *mag_data);
```

### 通用接口（两种模式都可用）

```c
// 初始化
void BMM350_Demo_Init(void);
int8_t BMM350_Init(void);
int8_t BMM350_Factory_Calibration(void);

// 数据读取（轮询模式专用）
void BMM350_Demo_Loop(void);
uint8_t BMM350_Is_Data_Ready(void);
int8_t BMM350_Get_Compensated_Data(struct bmm350_mag_temp_data *mag_data);
int8_t BMM350_Get_Raw_Data(struct bmm350_raw_mag_data *raw_data);
```

## 🎯 最佳实践

### 推荐配置（当前配置）

- ✅ **工作模式**: 中断驱动
- ✅ **采样率**: 400Hz（最高性能）
- ✅ **噪声模式**: AVG=8（超低噪声）
- ✅ **中断引脚**: PB9（上升沿触发）
- ✅ **输出方式**: UART2, 2Mbps

### 优化建议

1. **降低串口输出频率**（可选）：
   ```c
   static uint8_t counter = 0;
   if (BMM350_Demo_Get_Latest_Data(&mag_data)) {
       counter++;
       if (counter >= 10) {  // 每10个数据输出1个（40Hz输出）
           // 输出数据
           counter = 0;
       }
   }
   ```

2. **使用DMA发送UART**（可选）：
   ```c
   HAL_UART_Transmit_DMA(&huart2, buffer, len);
   ```

3. **数据缓冲队列**（高级）：
   - 实现FIFO队列
   - 中断中写入队列
   - 主循环批量输出

## 📌 注意事项

1. **中断优先级**：
   - EXTI9_5优先级为0（最高）
   - 避免在中断中执行耗时操作
   - I2C读取耗时约100-200μs（可接受）

2. **线程安全**：
   - `bmm350_data_ready_flag`使用`volatile`修饰
   - 主循环读取数据时会自动清除标志
   - 无需额外互斥保护

3. **数据一致性**：
   - 中断中读取完整数据后才设置标志
   - 主循环一次性复制所有数据
   - 避免读取到不一致的数据

## 🚀 快速测试

1. **下载程序**：
   ```bash
   # 编译已完成
   # 使用ST-Link下载 build/Debug/IMU_ICM42688P.elf
   ```

2. **观察串口**（UART2, 2Mbps）：
   ```
   ========================================
       BMM350磁力计初始化
   ========================================
   [BMM350] Chip ID: 0x33
   [BMM350] 配置: ODR=400Hz, AVG=8(超低噪声)
   ...
   MAG:20.45,-15.32,42.18,25.30,1000
   MAG:20.48,-15.28,42.20,25.31,1003  ← 400Hz输出
   MAG:20.50,-15.30,42.22,25.30,1005
   ```

3. **用磁铁测试**：
   - 靠近传感器 → 磁场值增加数百μT
   - 远离传感器 → 磁场值恢复正常

4. **示波器观察**（可选）：
   - 探测PB9引脚
   - 应看到400Hz的脉冲信号
   - 脉冲宽度约1.25ms

## 📖 相关文档

- **移植总结**: `doc/BMM350_移植总结.md`
- **测试指南**: `doc/BMM350_测试指南.md`
- **芯片手册**: `doc/bst-bmm350-ds001.md`

## 🎊 完成状态

- ✅ 轮询模式实现
- ✅ 中断模式实现
- ✅ 双模式支持（可切换）
- ✅ 编译通过
- ✅ 资源优化（RAM/Flash降低）
- ⏳ 硬件测试（等待您的验证）

---

**创建时间**: 2024-10-29  
**版本**: v1.1（中断模式）  
**作者**: AI Assistant  

