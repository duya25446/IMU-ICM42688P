# BMM350磁力计测试指南

## 编译结果

✅ **编译成功！**

```
[38/38] Linking C executable IMU_ICM42688P.elf
Memory region         Used Size  Region Size  %age Used
             RAM:        4288 B        32 KB     13.09%
           FLASH:       69076 B       128 KB     52.70%
```

## 硬件连接检查

在下载程序之前，请确认以下硬件连接：

### BMM350磁力计连接（I2C1）
- **VDD**: 1.8V电源
- **VDDIO**: 1.8V或3.3V（IO电压）
- **GND**: 地线
- **SCL**: I2C1_SCL（参考原理图）
- **SDA**: I2C1_SDA（参考原理图）
- **ADSEL**: **接地**（设置I2C地址为0x14）
- **INT**: PB9（上升沿触发，当前为轮询模式，中断引脚保留备用）
- **CRST**: 需要连接2.2μF电容到GND（磁场复位所需）

### 串口连接
- **UART2**: 2Mbps，用于调试输出和数据显示
  - TX: PA2
  - RX: PA3（可选）

## 下载程序

1. 连接ST-Link或其他调试器到STM32G4
2. 执行下载命令：
   ```bash
   cd /home/duya25446/Documents/STM32Project/IMU-ICM42688P
   # 使用你的下载工具，例如：
   # openocd -f interface/stlink.cfg -f target/stm32g4x.cfg -c "program build/Debug/IMU_ICM42688P.elf verify reset exit"
   ```

## 预期串口输出

### 初始化阶段

程序启动后，UART2应输出以下信息：

```
========================================
    BMM350磁力计初始化
========================================
[BMM350] Chip ID: 0x33
[BMM350] 配置: ODR=400Hz, AVG=8(超低噪声)
[BMM350] 已切换到Normal Mode
[BMM350] ✓ 初始化成功

========== BMM350出厂校准开始 ==========
[BMM350] 执行磁场复位...
[BMM350] 磁场复位完成
[BMM350] 执行X/Y轴自检...
[BMM350] X轴自检结果: XXX.XX μT
[BMM350] Y轴自检结果: XXX.XX μT
[BMM350] ✓ 自检通过（X/Y轴磁场变化≥130μT）

---------- 校准参数 ----------
磁场Offset: X=XXX.XX, Y=XXX.XX, Z=XXX.XX
磁场Sensitivity: X=XXX.XX, Y=XXX.XX, Z=XXX.XX
温度Offset: XXX.XX
温度Sensitivity: XXX.XX
TCO: X=XXX.XX, Y=XXX.XX, Z=XXX.XX
TCS: X=X.XXXX, Y=X.XXXX, Z=X.XXXX
T0: XXX.XX
========== 出厂校准完成 ==========

[BMM350] ✓ 出厂校准成功

========================================
    开始采集磁场数据 (400Hz)
========================================
格式: MAG:x(μT),y(μT),z(μT),temp(°C),timestamp(ms)

```

### 数据采集阶段

每2.5ms（400Hz）输出一行磁场数据：

```
MAG:20.45,-15.32,42.18,25.30,1000
MAG:20.48,-15.28,42.20,25.31,1003
MAG:20.50,-15.30,42.22,25.30,1005
...
```

**数据格式说明：**
- `MAG:` - 数据标识
- 第1字段：X轴磁场（μT）
- 第2字段：Y轴磁场（μT）
- 第3字段：Z轴磁场（μT）
- 第4字段：温度（°C）
- 第5字段：时间戳（ms）

## 功能验证

### 1. 初始化验证
- [ ] 串口输出"Chip ID: 0x33"
- [ ] 串口输出"初始化成功"
- [ ] 串口输出"配置: ODR=400Hz, AVG=8(超低噪声)"

### 2. 自检验证
- [ ] X轴自检结果 ≥ 130μT
- [ ] Y轴自检结果 ≥ 130μT
- [ ] 串口输出"自检通过"

### 3. 校准参数验证
- [ ] 输出磁场Offset（X/Y/Z）
- [ ] 输出磁场Sensitivity（X/Y/Z）
- [ ] 输出TCO/TCS温度补偿系数

### 4. 数据采集验证
- [ ] 数据持续输出，频率约400Hz
- [ ] 温度值在合理范围（室温约25°C）
- [ ] 磁场值在合理范围（地磁场约20-60μT）

### 5. 磁场响应测试

**测试步骤：**
1. 记录初始磁场值（X/Y/Z）
2. 用磁铁靠近传感器（距离约5-10cm）
3. 观察数值变化

**预期结果：**
- 靠近时磁场值显著增加（数百μT）
- 远离时恢复初始值
- 不同方向靠近，对应轴的数值变化最大

**示例：**
```
初始: MAG:20.45,-15.32,42.18,25.30,1000
磁铁靠近X轴正方向:
      MAG:520.45,-15.32,42.18,25.30,1100  ← X轴增加约500μT
磁铁移开:
      MAG:20.45,-15.32,42.18,25.30,1200   ← 恢复正常
```

### 6. 温度测试（可选）
- 用手指轻触传感器封装
- 观察温度值缓慢上升（约1-2°C）

## 常见问题排查

### 问题1：串口无输出
**可能原因：**
- 串口波特率设置错误（应为2Mbps）
- 串口线未正确连接
- 程序未正常运行

**解决方法：**
1. 检查串口配置：2Mbps, 8N1
2. 确认UART2连接（PA2-TX, PA3-RX）
3. 检查程序是否正常下载

### 问题2：初始化失败
**串口输出：** `[BMM350] ✗ 初始化失败，错误码: -2`

**可能原因：**
- I2C连接问题（错误码-2表示通信失败）
- BMM350未供电或供电电压不正确
- ADSEL引脚未接地

**解决方法：**
1. 用万用表检查VDD是否为1.8V
2. 确认I2C1的SCL/SDA连接正确
3. 确认ADSEL接地（I2C地址0x14）
4. 检查I2C上拉电阻（通常2.2kΩ到VDD或VDDIO）

### 问题3：自检失败
**串口输出：** `[BMM350] ✗ 自检未通过（X/Y轴磁场变化<130μT）`

**可能原因：**
- CRST电容未连接或容值错误
- 周围有强磁场干扰
- 传感器损坏

**解决方法：**
1. 检查CRST引脚是否连接2.2μF电容到GND
2. 远离强磁场源（电机、扬声器、磁铁等）
3. 重新上电测试

### 问题4：数据不更新
**串口无数据输出或数据固定不变**

**可能原因：**
- 传感器未进入Normal Mode
- 数据就绪中断未配置正确
- 轮询频率问题

**解决方法：**
1. 检查串口输出是否有"已切换到Normal Mode"
2. 复位MCU重新初始化
3. 检查while循环是否正常执行

### 问题5：数据噪声大
**磁场数值跳变严重**

**可能原因：**
- I2C干扰
- 电源噪声
- EMI干扰

**解决方法：**
1. 在VDD和VDDIO引脚增加去耦电容（100nF靠近芯片）
2. I2C走线尽量短，远离高频信号
3. 增加地平面屏蔽

## 性能指标

### 正常工作指标
- **采样率**: 400Hz（间隔2.5ms）
- **分辨率**: ~0.1μT
- **测量范围**: ±2000μT（X/Y/Z轴）
- **噪声（RMS）**: 
  - X/Y轴: <400nT
  - Z轴: <900nT
- **温度范围**: -40°C ~ +85°C
- **功耗**: 约455μA @ 400Hz（超低噪声模式）

### 地磁场参考值
- **总强度**: 约25-65μT（取决于地理位置）
- **水平分量**: 约15-40μT
- **垂直分量**: 约20-60μT（北半球向下为正）

## 数据记录建议

建议记录以下信息用于后续分析：

1. **初始化日志**：保存完整的初始化和校准输出
2. **静态数据**：传感器静止时采集10秒数据，计算噪声水平
3. **动态数据**：旋转传感器，观察三轴数据变化
4. **磁场响应**：用磁铁测试，记录响应幅度和恢复时间

## 下一步优化方向

1. **中断驱动模式**：利用PB9外部中断，减少CPU占用
2. **数据滤波**：添加移动平均或卡尔曼滤波，降低噪声
3. **姿态融合**：结合ICM42688P IMU数据，实现9轴姿态解算
4. **校准算法**：实现椭球拟合，消除硬磁/软磁干扰
5. **低功耗模式**：使用Forced Mode，实现更低功耗

## 技术支持

如有问题，请检查：
1. `Core/Inc/BMM350/` 目录下的头文件注释
2. `Core/Src/BMM350/` 目录下的实现代码
3. Bosch BMM350数据手册：`doc/bst-bmm350-ds001.md`
4. 本项目README.md

---

**创建时间**: 2024-10-29  
**版本**: v1.0  
**作者**: AI Assistant  

