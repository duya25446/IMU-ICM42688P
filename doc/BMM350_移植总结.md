# BMM350磁力计库移植总结

## ✅ 移植完成

BMM350磁力计库已成功移植到STM32G4项目，所有代码已编译通过。

## 📁 文件结构

```
Core/
├── Src/
│   └── BMM350/                    ← 新增目录
│       ├── bmm350.c              (Bosch原库，56KB)
│       ├── bmm350_oor.c          (超量程检测)
│       ├── BMM350_Platform.c     (STM32 I2C适配层)
│       ├── BMM350_Driver.c       (驱动封装层)
│       └── BMM350_Demo.c         (Demo程序)
└── Inc/
    └── BMM350/                    ← 新增目录
        ├── bmm350.h              (Bosch原库API)
        ├── bmm350_defs.h         (寄存器定义)
        ├── bmm350_oor.h          (超量程检测)
        ├── BMM350_Platform.h     (平台适配接口)
        ├── BMM350_Driver.h       (驱动接口)
        └── BMM350_Demo.h         (Demo接口)
```

## 🔧 配置参数

| 参数 | 配置值 | 说明 |
|------|--------|------|
| I2C接口 | I2C1 | 使用I2C1与BMM350通信 |
| I2C地址 | 0x14 | ADSEL引脚接地 |
| 采样率 | 400Hz | 最高频率 |
| 平均次数 | 8次 | 超低噪声模式 |
| 工作模式 | Normal Mode | 连续采样 |
| 数据方式 | 轮询 | 查询INT_STATUS寄存器 |
| 中断引脚 | PB9 | 保留备用（上升沿触发） |
| 调试串口 | UART2 (2Mbps) | 输出调试信息和数据 |

## 📊 资源占用

```
Memory region         Used Size  Region Size  %age Used
             RAM:        4288 B        32 KB     13.09%
           FLASH:       69076 B       128 KB     52.70%
```

**增量占用**（相比移植前）：
- Flash增加约10KB（BMM350库代码）
- RAM增加约1KB（设备结构体和缓冲区）

## ✨ 功能特性

### 已实现功能

- ✅ **自动初始化**：上电自动检测BMM350并配置为最高性能模式
- ✅ **出厂校准**：
  - 磁场复位（消除强磁场影响）
  - X/Y轴自检（验证≥130μT磁场变化）
  - 校准参数输出（Offset、Sensitivity、TCO、TCS等）
- ✅ **数据采集**：
  - 补偿后的磁场数据（X/Y/Z轴，单位μT）
  - 温度数据（单位°C）
  - 400Hz高速采样
- ✅ **串口输出**：
  - 初始化状态
  - 校准结果
  - 实时磁场数据（格式：`MAG:x,y,z,temp,timestamp`）

### 技术亮点

1. **Dummy Data处理**：正确处理BMM350 I2C读取的2字节dummy data
2. **模块化设计**：分层架构（Platform层、Driver层、Demo层）
3. **代码规范**：符合STM32编码规范，中文注释，Doxygen格式
4. **零侵入性**：独立目录，不影响原有ICM42688P代码
5. **易于扩展**：预留中断驱动接口，可快速切换到中断模式

## 📝 API接口

### 初始化和校准
```c
void BMM350_Demo_Init(void);  // 完整初始化流程（含出厂校准）
int8_t BMM350_Init(void);     // 仅初始化BMM350
int8_t BMM350_Factory_Calibration(void);  // 执行出厂校准
```

### 数据读取
```c
void BMM350_Demo_Loop(void);  // 轮询并输出磁场数据
uint8_t BMM350_Is_Data_Ready(void);  // 检查数据是否就绪
int8_t BMM350_Get_Compensated_Data(struct bmm350_mag_temp_data *mag_data);  // 读取补偿数据
int8_t BMM350_Get_Raw_Data(struct bmm350_raw_mag_data *raw_data);  // 读取原始数据
```

### 设备管理
```c
struct bmm350_dev* BMM350_Get_Device(void);  // 获取设备结构体指针
```

## 🚀 快速开始

### 1. 编译项目
```bash
cd /home/duya25446/Documents/STM32Project/IMU-ICM42688P
./clear.bash
```

### 2. 下载程序
使用ST-Link或其他调试器下载 `build/Debug/IMU_ICM42688P.elf` 到STM32G4

### 3. 查看串口输出
连接UART2（2Mbps），查看初始化和数据输出：
```
========================================
    BMM350磁力计初始化
========================================
[BMM350] Chip ID: 0x33
[BMM350] 配置: ODR=400Hz, AVG=8(超低噪声)
...
MAG:20.45,-15.32,42.18,25.30,1000
MAG:20.48,-15.28,42.20,25.31,1003
```

### 4. 磁场测试
用磁铁靠近传感器，观察磁场值变化（应增加数百μT）

## 📖 参考文档

- **测试指南**：[BMM350_测试指南.md](./BMM350_测试指南.md)
- **芯片手册**：[bst-bmm350-ds001.md](./bst-bmm350-ds001.md)
- **移植计划**：查看项目根目录的 `.plan.md` 文件

## 🔍 代码位置

| 功能 | 文件位置 |
|------|---------|
| 平台适配 | `Core/Src/BMM350/BMM350_Platform.c` |
| 驱动封装 | `Core/Src/BMM350/BMM350_Driver.c` |
| Demo程序 | `Core/Src/BMM350/BMM350_Demo.c` |
| 主程序集成 | `Core/Src/main.c` (line 33, 209, 232) |

## ⚠️ 硬件要求

### 必需连接
- **VDD**: 1.8V电源
- **VDDIO**: 1.8V或3.3V
- **GND**: 地线
- **SCL/SDA**: I2C1（参考原理图）
- **ADSEL**: **接地**（重要！设置I2C地址为0x14）
- **CRST**: 连接2.2μF电容到GND（必需！用于磁场复位）

### 可选连接
- **INT**: PB9（当前未使用，预留中断驱动功能）

## 🎯 下一步建议

### 功能优化
1. **中断驱动模式**：使能PB9外部中断，减少CPU占用
2. **数据滤波**：添加移动平均或卡尔曼滤波
3. **姿态融合**：结合ICM42688P，实现9轴AHRS
4. **磁力计校准**：实现椭球拟合，消除硬磁/软磁干扰

### 性能优化
1. **降低功耗**：切换到Forced Mode（单次触发）
2. **DMA传输**：使用I2C DMA减少中断开销
3. **异步读取**：避免阻塞等待数据就绪

### 应用场景
1. **电子罗盘**：计算方位角（需要倾斜补偿）
2. **姿态解算**：9轴融合，输出四元数
3. **室内导航**：磁场指纹定位
4. **金属检测**：检测周围金属物体

## 📞 技术支持

如遇问题，请检查：
1. 硬件连接是否正确（特别是ADSEL和CRST）
2. I2C通信是否正常（可用示波器查看波形）
3. 串口配置是否为2Mbps, 8N1
4. 参考 `doc/BMM350_测试指南.md` 排查故障

---

**移植完成日期**: 2024-10-29  
**移植版本**: v1.0  
**目标平台**: STM32G431  
**编译器**: arm-none-eabi-gcc 13.3.1  

