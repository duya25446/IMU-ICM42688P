# STM32G4 IMU-ICM42688P 惯性测量单元系统完整文档

**文档版本**: 1.0  
**最后更新**: 2025-10-02  
**项目状态**: 基础功能开发完成  

---

**目录**
- [第一部分: 项目概述与基本信息](#第一部分-项目概述与基本信息)
- [第二部分: 详细技术文档](#第二部分-详细技术文档)
- [第三部分: 快速参考指南](#第三部分-快速参考指南)
- [第四部分: 项目交接清单](#第四部分-项目交接清单)

---

# 第一部分: 项目概述与基本信息

## 项目基本信息

**项目名称**: IMU-ICM42688P 惯性测量单元系统  
**微控制器**: STM32G431CBUx (ARM Cortex-M4, 170MHz)  
**传感器**: ICM-42688P 六轴IMU (陀螺仪 + 加速度计)  
**通信接口**: 2路UART (2Mbps), 1路SPI (21.25MHz)  
**构建系统**: CMake 3.22+ / Keil MDK-ARM  
**姿态算法**: 待实现  
**开发语言**: C (C11标准)  
**开发阶段**: 基础数据采集功能开发完成  

## 项目简介

本项目实现了一个基于STM32G4微控制器的高精度惯性测量单元(Inertial Measurement Unit, IMU)数据采集系统。系统采用InvenSense公司的ICM-42688P六轴运动传感器,集成了三轴陀螺仪与三轴加速度计,通过SPI高速接口与微控制器通信。系统提供实时原始传感器数据采集功能,并通过双路UART接口以2Mbps波特率向外部设备输出运动数据。姿态解算算法模块待后续实现。

项目采用CMake构建系统,支持多种构建配置模式(Debug、Release、RelWithDebInfo、MinSizeRel),使用ARM GCC工具链进行交叉编译,同时保留了Keil MDK-ARM项目文件以支持传统开发环境。系统设计注重实时性与精度,采用定时器中断驱动的数据采集流程,实现了1kHz的数据更新率。

## 核心性能指标

| 指标 | 数值 |
|------|------|
| 数据采集频率 | 1000 Hz |
| 中断处理时间 | < 100 μs |
| CPU占用率 | < 10% |
| SPI通信速度 | 21.25 MHz |
| UART波特率 | 2 Mbps |
| 加速度分辨率 | 0.000488 g |
| 陀螺仪分辨率 | 0.061 dps |
| Flash使用 | ~30-40 KB |
| RAM使用 | ~5-10 KB |

---

# 第二部分: 详细技术文档

## 1. 硬件平台规格

### 1.1 微控制器核心

本系统基于STMicroelectronics的STM32G431CBUx微控制器,其主要技术参数如下:该芯片采用ARM Cortex-M4核心架构,主频最高可达170MHz,内置硬件浮点运算单元(FPU)支持单精度浮点运算,配备128KB Flash存储器与32KB SRAM。微控制器工作于Voltage Scale 1 Boost模式,以获得最高性能。

系统时钟配置采用外部高速振荡器(HSE)通过旁路模式提供基准时钟,锁相环(PLL)配置为5分频输入、68倍频输出,并经过2分频后作为系统时钟源,最终实现170MHz的系统主频。AHB总线、APB1总线与APB2总线均配置为不分频模式,以最大化外设性能。Flash访问延迟配置为4等待周期以匹配高频率运行需求。

### 1.2 惯性测量单元传感器

ICM-42688P是一款高性能六轴运动跟踪传感器,集成了三轴陀螺仪与三轴加速度计。本系统配置陀螺仪量程为±2000度每秒(dps),加速度计量程为±16g。传感器采用16位模数转换器(ADC),陀螺仪灵敏度为2000/32768≈0.061 dps/LSB,加速度计灵敏度为16/32768≈0.000488 g/LSB。

传感器通过SPI接口与微控制器通信,片选信号连接至PC4引脚,支持高达24MHz的SPI时钟频率。系统配置陀螺仪与加速度计的输出数据率(ODR)寄存器为1,实现高速数据采集。传感器支持数据就绪中断功能,可通过PB0引脚连接中断信号线,采用上升沿触发模式。

### 1.3 通信接口配置

系统配置了两路全双工UART通信接口,均工作于2,000,000bps高速波特率,8位数据位、1位停止位、无校验位配置。UART1与UART2均启用DMA接收功能,采用接收空闲检测中断(ReceiveToIdle)机制实现动态长度数据包接收。DMA配置为通道1服务USART1接收、通道2服务USART2接收,接收缓冲区长度为40字节,且禁用半传输中断以优化性能。

系统还配置了TIM2定时器作为PWM输出源,工作于通道1,周期寄存器设置为5187,比较寄存器设置为2594,输出约50%占空比的PWM波形,可用于驱动外部设备或作为时钟参考。TIM3定时器配置为基本定时器,预分频系数为169(170-1),自动重装载值为999,产生1kHz的定时中断,作为IMU数据采集与姿态更新的时间基准。

## 2. 软件架构设计

### 2.1 系统分层结构

软件架构采用分层设计理念,自下而上包含硬件抽象层(HAL)、驱动层、算法层与应用层。硬件抽象层由STM32 HAL库提供,封装了寄存器级操作,提供统一的外设访问接口。驱动层实现ICM-42688P传感器的初始化、配置与数据读取功能,定义在`ICM-42688P.c`与`ICM-42688P.h`文件中。算法层预留用于实现姿态融合算法,目前尚未实现。应用层位于`main.c`中,负责系统初始化、主循环控制与中断服务例程协调。

系统采用中断驱动的事件处理模型,TIM3定时器每毫秒触发一次中断,在中断服务例程中完成时间戳递增操作并设置处理标志。主循环负责检测`timertag`标志位,当标志置位时进行传感器数据读取、数据平均计算与UART数据发送,实现周期性的数据输出功能。

### 2.2 数据流处理过程

系统数据流始于TIM3定时器中断,以1kHz频率触发数据处理流程。中断服务例程递增时间戳变量并设置`timertag`标志,通知主循环进行数据处理。

主循环检测到`timertag`标志后,调用`ICM42688P_ReadIMUData()`函数,通过SPI接口从传感器的0x1F起始地址连续读取12字节原始数据,包括加速度计X、Y、Z轴与陀螺仪X、Y、Z轴的16位ADC值。读取的数据经过大端序解析,将字节流转换为六个有符号16位整数。

随后根据传感器灵敏度将整数ADC值转换为物理单位,加速度单位为g(重力加速度),角速度单位为dps(度每秒)。转换后的数据叠加预定义的零点偏移补偿值(`axzeroffset`、`gxzeroffset`等),并进行阈值滤波,当陀螺仪读数绝对值小于0.2dps时置零以消除静态漂移。

处理后的原始数据存储在全局`imudata`结构体中。主循环对陀螺仪数据进行256次累加平均,降低数据输出频率至约3.9Hz,减少通信带宽占用。平均后的数据通过`sprintf()`格式化为ASCII字符串,格式为"IMUData:x,y,z\n",通过`HAL_UART_Transmit()`函数经UART2接口发送至外部设备。

## 3. ICM-42688P传感器驱动实现

### 3.1 驱动架构与接口封装

ICM-42688P驱动层提供了模块化的函数接口,实现传感器的完整生命周期管理。底层SPI通信封装为三个基础函数:`spi_sendbytes()`用于发送字节流,`spi_readbytes()`用于接收字节流,片选信号通过宏定义`cs_high()`与`cs_low()`控制PC4引脚电平。

寄存器访问层面,`ICM42688P_WriteRegister()`函数实现寄存器写入操作,并通过回读验证写入正确性,返回值指示操作是否成功。`ICM42688P_ReadRegister()`函数实现寄存器读取,支持连续读取多个字节。`ICM42688P_BankSEL()`函数用于切换寄存器组(Bank),ICM-42688P采用分组寄存器映射,需通过0x76地址的REG_BANK_SEL寄存器切换访问不同功能区域。

### 3.2 初始化配置序列

传感器初始化流程由`ICM42688P_Init()`函数实现,严格遵循数据手册规定的上电时序。首先拉高片选信号确保SPI总线空闲,随后调用`ICM42688P_SoftwareReset()`函数向0x11地址的DEVICE_CONFIG寄存器写入0x01触发软件复位,延时10ms等待复位完成。

时钟配置通过`ICM42688P_CLK_Config()`函数实现,首先切换至Bank 1寄存器组,向0x7B地址的INTF_CONFIG1寄存器写入0x04配置时钟源,然后切换回Bank 0,向0x4D地址的PWR_MGMT0寄存器写入0x95,启用加速度计与陀螺仪的低噪声模式。

数据率配置通过`ICM42688P_ODRcfg()`函数完成,向0x4F地址的GYRO_CONFIG0寄存器与0x50地址的ACCEL_CONFIG0寄存器分别写入0x01,配置量程与输出数据率。最后调用`ICM42688P_Start()`函数向0x4E地址的PWR_MGMT0寄存器写入0x0F,使能陀螺仪与加速度计,启动数据采集。

### 3.3 数据解析与校准

原始数据读取由`ICM42688P_ReadIMUData()`函数实现,从0x1F起始地址连续读取12字节,依次为加速度X高字节、加速度X低字节、加速度Y高低字节、加速度Z高低字节、陀螺仪X高低字节、陀螺仪Y高低字节、陀螺仪Z高低字节。

数据解析采用大端序方式,高字节左移8位后与低字节进行按位或运算,转换为16位有符号整数。物理单位转换通过预定义的灵敏度常数实现,`ACCEL_SENSITIVITY`定义为16.0/32768.0,`GYRO_SENSITIVITY`定义为2000.0/32768.0。

零点偏移校准通过宏定义配置,系统预留两组校准参数(IMU1与IMU2),当前使用IMU2配置,所有偏移量均设置为0.0。实际应用中可通过静态标定过程测量零点漂移,更新宏定义值以提高测量精度。

陀螺仪静态阈值滤波采用0.2dps门限值,当测量值绝对值小于该阈值加上浮点误差容限(`FLT_EPSILON`)时,将数值强制归零,有效抑制静止状态下的累积误差。

## 4. 中断处理与实时调度

### 4.1 中断优先级配置

系统配置了多个中断源,优先级管理遵循ARM Cortex-M4 NVIC(Nested Vectored Interrupt Controller)架构。DMA1通道1与通道2中断(服务USART1与USART2接收)配置为抢占优先级0、子优先级0,保证UART数据接收的实时性。TIM3定时器中断采用默认优先级,低于DMA中断,确保数据采集任务可被通信中断抢占,避免丢失外部命令。

SysTick系统滴答定时器用于HAL库时基,提供`HAL_Delay()`等延时函数与超时检测功能,配置为1ms周期,与应用层TIM3定时器分离,避免相互干扰。

### 4.2 TIM3定时器中断服务

TIM3定时器中断服务例程定义在`stm32g4xx_it.c`文件的`TIM3_IRQHandler()`函数中。中断触发后,首先调用`HAL_TIM_IRQHandler()`清除中断标志,随后执行用户代码:递增64位全局时间戳变量`timestamp`,设置`timertag`标志通知主循环执行数据处理与输出任务。

该中断服务例程执行时间非常短,在170MHz主频下仅需几个微秒,为算法处理预留充足的计算时间。

### 4.3 UART空闲中断处理

UART接收采用DMA配合空闲中断机制,无需CPU参与逐字节搬运,降低处理器负载。当UART检测到接收线空闲(连续一段时间无数据)时,触发空闲中断,调用`HAL_UARTEx_RxEventCallback()`回调函数。

回调函数根据`huart`句柄判断触发源(UART1或UART2),用于处理外部命令。当前实现为预留接口,具体数据输出逻辑待实现。中断服务例程末尾重新启动DMA接收,调用`HAL_UARTEx_ReceiveToIdle_DMA()`函数并禁用半传输中断,循环监听新的命令数据包。

## 5. 构建系统与工具链

### 5.1 CMake构建配置

项目采用CMake 3.22及以上版本作为构建系统,支持跨平台开发与灵活的构建配置。根目录`CMakeLists.txt`文件定义了项目结构,设置C语言标准为C11,启用编译命令导出功能(用于代码智能感知)。

项目定义为可执行对象类型,通过`add_executable()`命令创建目标,链接stm32cubemx子项目生成的HAL库。用户源文件明确列出:`ICM-426688P.c`,避免全局通配符导致的构建不确定性。

链接器选项配置支持浮点打印功能,通过`-u _printf_float`强制链接浮点格式化代码,满足IMU数据输出需求。

### 5.2 工具链交叉编译配置

工具链配置文件`cmake/gcc-arm-none-eabi.cmake`定义了ARM裸机交叉编译环境。编译器设置为`arm-none-eabi-gcc`,链接器使用`arm-none-eabi-g++`,支持C与C++混合编译。

目标架构标志设置为`-mcpu=cortex-m4 -mfpu=fpv4-sp-d16 -mfloat-abi=hard`,指定Cortex-M4处理器、单精度浮点单元与硬件浮点ABI,充分利用FPU硬件加速浮点运算。

编译优化选项区分构建类型:Debug模式使用`-O0 -g3`禁用优化并生成完整调试信息,Release模式使用`-Os -g0`优化代码尺寸并去除调试符号,适合固件发布。编译器警告开关`-Wall`启用全部警告,`-fdata-sections`与`-ffunction-sections`选项配合链接器`--gc-sections`标志实现死代码消除,减小固件体积。

链接脚本指定为`STM32G431XX_FLASH.ld`,定义Flash起始地址0x08000000、大小128KB,RAM起始地址0x20000000、大小32KB。链接器标志`--specs=nano.specs`选择newlib-nano精简C库,减少固件尺寸,`--print-memory-usage`选项在链接时输出存储器使用统计。

### 5.3 构建预设与多配置支持

`CMakePresets.json`文件定义了四种标准构建配置:debug(调试版本,完整符号信息)、release(发布版本,最高性能)、relWithDebInfo(发布版本保留调试信息)、minSizeRel(最小尺寸优化)。所有预设继承默认配置,使用Ninja生成器以获得最快构建速度,工具链文件统一指定为gcc-arm-none-eabi.cmake。

构建流程分为配置阶段与编译阶段,配置命令示例:`cmake --preset=debug`,编译命令示例:`cmake --build --preset=debug`。生成的二进制文件位于`build/debug/IMU_ICM42688P.elf`,可通过`arm-none-eabi-objcopy`转换为bin或hex格式,用于固件烧录。

### 5.4 Keil MDK-ARM支持

项目保留`MDK-ARM`目录下的Keil工程文件,支持使用µVision IDE开发。工程配置文件`IMU_ICM42688P.uvprojx`定义了相同的编译器选项与链接脚本,确保CMake与Keil构建结果一致性。`startup_stm32g431xx.s`启动文件定义中断向量表与堆栈配置,Reset_Handler初始化.data段与.bss段,随后跳转至main函数。

## 6. 数据结构定义

### 6.1 IMU_Data结构体

核心数据结构`IMU_Data`定义于`ICM-42688P.h`,采用双精度浮点类型存储测量值与姿态信息。加速度字段`accel_x`、`accel_y`、`accel_z`单位为g(1g=9.80665m/s²),角速度字段`gyro_x`、`gyro_y`、`gyro_z`单位为度每秒(dps)。姿态四元数字段`q0`(实部)、`q1`(i)、`q2`(j)、`q3`(k)为单位四元数,满足\( q_0^2 + q_1^2 + q_2^2 + q_3^2 = 1 \)。

时间戳字段`timestamp`采用64位无符号整数,以毫秒为单位递增,用于数据同步与时序分析,但当前实现中该字段未与外部时钟源同步,仅作为相对时间参考。

## 7. 通信协议规范

### 7.1 数据输出格式

系统通过UART2接口周期性输出IMU数据,采用ASCII文本协议便于人类阅读与调试。标准输出格式为"IMUData:value1,value2,value3\n",其中value为浮点数的十进制表示,字段间以逗号分隔,消息以换行符终止。

当前实现输出陀螺仪平均值,消息示例:"IMUData:0.123,-0.456,0.789\n",分别对应256次采样平均后的X、Y、Z轴角速度。代码中注释部分显示四元数输出格式:"IMUData:q0,q1,q2,q3\n",可通过修改`main.c`中的格式化字符串切换输出内容。

### 7.2 命令接收机制

UART1与UART2均配置DMA接收模式,缓冲区长度40字节,支持接收外部命令。当检测到接收空闲事件时,触发`HAL_UARTEx_RxEventCallback()`回调,当前实现为预留接口,未实现具体功能。

扩展应用可设计命令帧格式,例如TLV(类型-长度-值)结构:首字节为命令类型(0x01查询状态、0x02设置参数、0x03校准命令),第二字节为数据长度,后续字节为命令参数,最后一字节为校验和。接收端解析命令类型并调用相应处理函数,实现双向交互控制。

## 8. 系统性能指标

### 8.1 实时性能分析

系统实现1kHz的传感器数据采集频率,满足高动态运动跟踪需求。TIM3中断周期严格为1毫秒,中断服务例程执行时间极短(仅数微秒),处理器占用率低于10%,为算法实现预留充足的计算资源。

SPI通信配置8分频波特率,系统时钟170MHz下SPI时钟为21.25MHz,传输12字节数据耗时约4.5微秒,相比中断周期可忽略不计。UART传输速率2Mbps,发送30字节消息耗时约120微秒,与数据采集周期异步执行,不影响实时性。

### 8.2 精度与稳定性

加速度计测量精度受ADC分辨率与噪声限制,理论分辨率0.000488g,实际噪声水平约0.01g RMS。陀螺仪分辨率0.061dps,噪声密度约0.004dps/√Hz,在1kHz采样率下等效噪声约0.13dps。

当前系统仅提供原始IMU数据,姿态估计精度取决于后续实现的算法。传感器本身的噪声水平为:加速度计约0.01g RMS,陀螺仪约0.13dps。

零点漂移主要来自陀螺仪温度特性,ICM-42688P典型温度漂移±1dps/°C,在恒温环境下可通过静态标定有效补偿。系统提供零点偏移宏定义配置机制,用户应在目标工作温度下采集静态数据,计算平均偏移量并更新头文件中的校准常数。

## 9. 文件组织结构

项目采用STM32CubeMX生成的标准目录结构,核心源文件位于`Core/Src`与`Core/Inc`目录。`main.c`为应用入口,`stm32g4xx_it.c`包含中断服务例程,`stm32g4xx_hal_msp.c`定义HAL库回调函数用于外设引脚配置,`system_stm32g4xx.c`实现系统时钟初始化。

传感器驱动文件`ICM-426688P.c`与头文件`ICM-42688P.h`实现ICM-42688P完整功能封装。

HAL驱动库位于`Drivers/STM32G4xx_HAL_Driver`目录,包含外设驱动源码与头文件。CMSIS核心与设备支持文件位于`Drivers/CMSIS`目录,提供ARM Cortex-M4核心寄存器定义与STM32G4设备头文件。

构建系统文件位于根目录与`cmake`子目录,`CMakeLists.txt`为主构建脚本,`CMakePresets.json`定义预设配置,`cmake/gcc-arm-none-eabi.cmake`为工具链文件,`cmake/stm32cubemx/CMakeLists.txt`为HAL库子项目构建脚本。

链接脚本`STM32G431XX_FLASH.ld`定义存储器布局,启动文件`startup_stm32g431xx.s`包含中断向量表与初始化代码。STM32CubeMX配置文件`IMU_ICM42688P.ioc`可用于重新生成初始化代码,但需注意保护用户代码区域避免被覆盖。

## 10. 扩展应用方向

### 10.1 姿态控制系统集成

本IMU系统可作为姿态控制系统的传感器模块,输出的四元数可转换为欧拉角(俯仰、横滚、航向),供PID控制器或模型预测控制器使用。四元数到欧拉角的转换公式为:

俯仰角(pitch): \( \theta = \arcsin(2(q_0 q_2 - q_3 q_1)) \)

横滚角(roll): \( \phi = \arctan2(2(q_0 q_1 + q_2 q_3), 1 - 2(q_1^2 + q_2^2)) \)

航向角(yaw): \( \psi = \arctan2(2(q_0 q_3 + q_1 q_2), 1 - 2(q_2^2 + q_3^2)) \)

集成磁力计可提供航向角绝对参考,消除陀螺仪漂移。推荐传感器包括QMC5883L或MMC5603NJ,通过I2C接口连接。需要在姿态解算算法中实现磁力计数据融合。

### 10.2 数据记录与离线分析

扩展SD卡接口可实现高速数据记录,采用SPI或SDIO模式连接SD卡模块,使用FatFs文件系统库创建CSV或二进制日志文件。记录内容包括时间戳、原始传感器数据、姿态四元数与算法内部状态,用于离线分析与算法参数优化。

Python或MATLAB脚本可解析日志文件,绘制姿态角时间序列、角速度频谱图与加速度轨迹,通过与地面真值对比评估系统精度。动作捕捉系统或高精度转台可提供姿态基准,计算RMSE与最大误差指标。

### 10.3 无线通信模块

替换有线UART为蓝牙(如HC-05)或Wi-Fi模块(如ESP8266),实现无线数据传输。蓝牙模块配置为透传模式,直接替换UART接口无需修改应用代码。Wi-Fi模块可实现TCP/IP协议栈,支持多客户端连接与更高数据率,适合实时数据流传输。

LoRa或Zigbee模块适用于长距离低功耗应用,牺牲数据率换取通信距离。修改数据输出频率与格式,采用二进制打包与数据压缩减少传输字节数。

## 11. 已知问题与注意事项

### 11.1 浮点打印性能

系统启用浮点printf支持(`-u _printf_float`链接选项),该功能依赖newlib的浮点格式化代码,占用约10KB Flash空间并显著增加sprintf执行时间(约100-200微秒)。对尺寸敏感应用可改用整数打印,将浮点数乘以固定倍数转换为整数,例如乘以1000后以毫单位输出。

### 11.2 文件命名不一致

传感器驱动文件存在命名不一致,头文件为`ICM-42688P.h`,源文件为`ICM-426688P.c`(注意第二个8与6的位置差异),导致某些大小写敏感文件系统上编译错误。建议统一修改为`ICM42688P.h`与`ICM42688P.c`,同时更新CMakeLists.txt中的引用。

### 11.3 时间戳同步

当前时间戳变量`timestamp`在中断中递增,但未实现跨系统同步机制。若需要与外部设备时间同步,应实现PPS(秒脉冲)信号接收,捕获上升沿中断时对齐时间戳,或通过网络时间协议(NTP)定期校准。

### 11.4 数据平均算法

主循环中的陀螺仪数据平均使用256次累加,存在整数溢出风险。虽然当前使用浮点累加器避免了该问题,但连续累加会积累浮点舍入误差,建议改用滑动平均或指数加权移动平均(EWMA)算法提高数值稳定性。

## 12. 技术文档总结

本详细技术文档全面描述了基于STM32G431微控制器与ICM-42688P传感器的惯性测量单元数据采集系统完整实现,涵盖硬件配置、软件架构、驱动实现、通信协议与构建系统各个方面。系统实现了1kHz高频率数据采集,通过双路高速UART接口实现数据输出与命令接收。

项目采用现代化的CMake构建系统,支持多配置编译与跨平台开发,同时保留Keil工程文件兼容传统开发流程。代码结构清晰,模块划分合理,易于维护与扩展。系统预留充足的处理器性能余量,支持集成姿态解算算法、磁力计、SD卡记录、无线通信等扩展功能,可广泛应用于无人机、机器人、姿态跟踪与运动分析等领域。

---

# 第三部分: 快速参考指南

## 硬件连接速查

### SPI1 连接 (ICM-42688P)
- **SCK**: PA5
- **MISO**: PA6
- **MOSI**: PA7
- **CS**: PC4 (软件控制)

### UART1
- **TX**: PA9
- **RX**: PA10
- **波特率**: 2,000,000 bps
- **用途**: 数据输出/命令接收

### UART2
- **TX**: PA2
- **RX**: PA3
- **波特率**: 2,000,000 bps
- **用途**: 数据输出/命令接收

### 定时器
- **TIM2**: PWM输出 (PA0, 通道1)
- **TIM3**: 1kHz定时中断(用于IMU数据采集)

### 中断引脚
- **PB0**: 外部中断(上升沿触发,预留用于IMU数据就绪信号)

## 关键参数速查

### 传感器配置
```c
陀螺仪量程: ±2000 dps
陀螺仪灵敏度: 0.061 dps/LSB (2000/32768)
加速度计量程: ±16g
加速度计灵敏度: 0.000488 g/LSB (16/32768)
数据输出率: 1kHz
通信接口: SPI模式3 (CPOL=1, CPHA=1)
SPI时钟: 21.25MHz (170MHz/8)
```

### 姿态算法配置
```c
待补充新算法的配置参数
```

## 核心函数速查

### 传感器驱动 (ICM-42688P.c)

| 函数名 | 功能 | 参数 |
|--------|------|------|
| `ICM42688P_Init()` | 初始化传感器 | 无 |
| `ICM42688P_Start()` | 启动数据采集 | 无 |
| `ICM42688P_Stop()` | 停止数据采集 | 无 |
| `ICM42688P_ReadIMUData()` | 读取IMU数据 | `IMU_Data *data` |
| `ICM42688P_GetTemp()` | 读取温度 | 返回值: float |
| `ICM42688P_WriteRegister()` | 写寄存器 | `reg_address`, `txdata`, `length` |
| `ICM42688P_ReadRegister()` | 读寄存器 | `reg_address`, `rxdata`, `length` |

### 姿态解算 (main.c)

| 函数名 | 功能 | 调用位置 |
|--------|------|----------|
| 待实现 | 姿态解算算法 | TIM3中断服务例程 |

### 中断处理 (stm32g4xx_it.c)

| 中断源 | 处理函数 | 功能 |
|--------|----------|------|
| TIM3 | `TIM3_IRQHandler()` | 触发IMU数据更新 (1kHz) |
| USART1 | `USART1_IRQHandler()` | UART1接收处理 |
| USART2 | `USART2_IRQHandler()` | UART2接收处理 |
| DMA1_CH1 | `DMA1_Channel1_IRQHandler()` | UART1 DMA接收 |
| DMA1_CH2 | `DMA1_Channel2_IRQHandler()` | UART2 DMA接收 |

## 数据结构速查

### IMU_Data 结构体
```c
typedef struct {
    double accel_x, accel_y, accel_z;  // 加速度 (g)
    double gyro_x, gyro_y, gyro_z;     // 角速度 (dps)
    double q0, q1, q2, q3;             // 姿态四元数
    uint64_t timestamp;                 // 时间戳 (ms)
} IMU_Data;
```

### 四元数到欧拉角转换
```c
// 俯仰角 (pitch)
pitch = asin(2 * (q0*q2 - q3*q1));

// 横滚角 (roll)
roll = atan2(2 * (q0*q1 + q2*q3), 1 - 2 * (q1*q1 + q2*q2));

// 航向角 (yaw)
yaw = atan2(2 * (q0*q3 + q1*q2), 1 - 2 * (q2*q2 + q3*q3));
```

## 通信协议速查

### UART输出格式
```
IMUData:<value1>,<value2>,<value3>\n
```

**示例** (陀螺仪数据):
```
IMUData:0.123,-0.456,0.789\n
```

**示例** (四元数数据):
```
IMUData:0.998,0.001,-0.002,0.003\n
```

### 数据输出频率
- 传感器采集: 1000 Hz (TIM3中断)
- 姿态更新: 1000 Hz (在中断中处理)
- UART输出: ~3.9 Hz (256次平均)

## 编译烧录速查

### 使用CMake
```bash
# 配置项目 (Debug模式)
cmake --preset=debug

# 编译
cmake --build --preset=debug

# 生成二进制文件
arm-none-eabi-objcopy -O binary \
  build/debug/IMU_ICM42688P.elf \
  build/debug/IMU_ICM42688P.bin
```

### 使用Keil MDK-ARM
1. 打开 `MDK-ARM/IMU_ICM42688P.uvprojx`
2. 选择目标配置 (Debug/Release)
3. 编译: Project → Build Target (F7)
4. 烧录: Flash → Download (F8)

### OpenOCD烧录
```bash
openocd -f interface/stlink.cfg -f target/stm32g4x.cfg \
  -c "program build/debug/IMU_ICM42688P.elf verify reset exit"
```

### STM32CubeProgrammer烧录
```bash
STM32_Programmer_CLI -c port=SWD \
  -w build/debug/IMU_ICM42688P.elf -v -rst
```

## 调试方法速查

### 串口监控
```bash
# Linux
minicom -D /dev/ttyUSB0 -b 2000000

# 或使用 screen
screen /dev/ttyUSB0 2000000

# macOS
screen /dev/tty.usbserial-* 2000000

# Windows (使用串口助手)
波特率: 2000000
数据位: 8
停止位: 1
校验: 无
```

### GDB调试
```bash
# 终端1: 启动OpenOCD
openocd -f interface/stlink.cfg -f target/stm32g4x.cfg

# 终端2: 启动GDB
arm-none-eabi-gdb build/debug/IMU_ICM42688P.elf

# GDB命令
(gdb) target remote localhost:3333
(gdb) monitor reset halt
(gdb) load
(gdb) break main
(gdb) continue
(gdb) print imudata
```

### 常用调试断点
```c
main.c:141          // ICM42688P初始化
main.c:179          // IMU数据读取（主循环）
stm32g4xx_it.c:246  // TIM3中断
ICM-426688P.c:121   // ICM42688P_ReadIMUData
```

## 文件结构速查

```
IMU-ICM42688P/
├── Core/
│   ├── Inc/                      # 头文件
│   │   ├── main.h               # 主程序头文件
│   │   ├── ICM-42688P.h         # 传感器驱动头文件
│   │   └── stm32g4xx_it.h       # 中断处理头文件
│   └── Src/                      # 源文件
│       ├── main.c               # 主程序
│       ├── ICM-426688P.c        # 传感器驱动实现
│       └── stm32g4xx_it.c       # 中断服务例程
├── Drivers/                      # HAL驱动库
│   ├── STM32G4xx_HAL_Driver/    # STM32 HAL库
│   └── CMSIS/                   # CMSIS核心文件
├── cmake/                        # CMake配置
│   ├── gcc-arm-none-eabi.cmake  # GCC工具链配置
│   └── stm32cubemx/             # CubeMX生成的CMake文件
├── MDK-ARM/                      # Keil工程文件
├── build/                        # 编译输出目录
├── CMakeLists.txt               # CMake主配置文件
├── CMakePresets.json            # CMake预设配置
├── STM32G431XX_FLASH.ld         # 链接脚本
└── IMU_ICM42688P.ioc            # STM32CubeMX配置文件
```

## 常见问题速查

### Q1: 编译错误 "ICM-426688P.c: No such file"
**原因**: 文件命名不一致  
**解决**: 头文件名为`ICM-42688P.h`,源文件名为`ICM-426688P.c`,注意第二个8和6的位置

### Q2: 串口无输出
**检查项**:
1. UART波特率是否正确设置为2000000
2. 串口线TX/RX是否接反
3. TIM3定时器是否正常启动
4. 检查`timertag`变量是否被设置

### Q3: IMU数据读取为0
**检查项**:
1. SPI接线是否正确
2. 片选信号(PC4)是否正常工作
3. 传感器是否正确初始化(`ICM42688P_Init()`返回值)
4. 使用逻辑分析仪检查SPI通信时序

### Q4: 姿态计算不稳定
**可能原因**:
1. 传感器未校准,修改零点偏移参数
2. 姿态算法未实现或参数不合适
3. 环境振动干扰,增加机械隔离

### Q5: 浮点打印不工作
**解决**: 确保CMakeLists.txt中包含以下行:
```cmake
target_link_options(${PROJECT_NAME} PRIVATE
    -u _printf_float
)
```

## 校准程序速查

### 零点偏移校准
1. 将IMU放置在静止水平面上
2. 采集1000-10000个样本
3. 计算各轴平均值
4. 更新`ICM-42688P.h`中的偏移宏定义:
```c
#define axzeroffset -0.123  // X轴加速度偏移
#define ayzeroffset 0.456   // Y轴加速度偏移
#define azzeroffset 0.789   // Z轴加速度偏移
#define gxzeroffset -1.234  // X轴陀螺仪偏移
#define gyzeroffset 2.345   // Y轴陀螺仪偏移
#define gzzeroffset -3.456  // Z轴陀螺仪偏移
```

### 加速度计校准 (六面法)
1. 将IMU各面分别朝上放置(+X,+Y,+Z,-X,-Y,-Z)
2. 每个位置采集数据
3. 计算增益与偏移矩阵
4. 在数据处理函数中应用校准矩阵

## 扩展功能建议速查

### 1. 磁力计集成
- 推荐传感器: QMC5883L, MMC5603NJ
- 接口: I2C
- 需要实现磁力计数据融合算法

### 2. SD卡数据记录
- 接口: SPI/SDIO
- 文件系统: FatFs
- 格式: CSV或二进制

### 3. 无线通信
- 蓝牙: HC-05 (透传模式)
- Wi-Fi: ESP8266/ESP32
- LoRa: SX1278 (长距离)

### 4. 显示屏输出
- OLED: SSD1306 (I2C)
- TFT: ST7735/ILI9341 (SPI)
- 显示内容: 姿态角、四元数、原始数据

## 参考资料

- **ICM-42688P数据手册**: `ds-000347_icm-42688-p-datasheet.pdf`
- **STM32G4参考手册**: RM0440
- **STM32 HAL库文档**: UM1786

---

# 第四部分: 项目交接清单

## 交接说明

本清单用于项目交接时的检查确认,确保接收方获得完整的项目信息与开发资源。

## 1. 文档交接清单

### 1.1 技术文档
- [x] **项目完整文档.md**: 包含技术文档、快速参考指南与交接清单的综合文档
- [x] **README.md**: 项目根目录说明文件(内容简略,建议扩充)
- [x] **ICM-42688P数据手册**: `ds-000347_icm-42688-p-datasheet.pdf`

### 1.2 设计文档
- [x] **STM32CubeMX配置文件**: `IMU_ICM42688P.ioc` (可重新生成初始化代码)
- [ ] **原理图**: (未提供,建议补充硬件原理图)
- [ ] **PCB布局图**: (未提供,建议补充)
- [x] **硬件接线说明**: 已在本文档第三部分说明
- [ ] **需求规格文档**: (未提供,建议根据实际需求补充)

### 1.3 用户手册
- [ ] **使用说明书**: (未提供,建议编写面向最终用户的操作手册)
- [x] **调试指南**: 已包含在本文档第三部分
- [ ] **故障排查手册**: (未提供,建议根据实际问题总结)

## 2. 源代码交接清单

### 2.1 核心源文件
- [x] `Core/Src/main.c` (574行): 主程序,系统初始化与主循环
- [x] `Core/Src/ICM-426688P.c` (202行): ICM-42688P驱动实现
- [x] `Core/Inc/ICM-42688P.h` (85行): 传感器驱动头文件
- [x] `Core/Src/stm32g4xx_it.c` (287行): 中断服务例程
- [x] `Core/Inc/stm32g4xx_it.h`: 中断声明头文件

### 2.2 算法库文件
- [ ] 姿态解算算法待实现

### 2.3 HAL库与系统文件
- [x] `Core/Src/stm32g4xx_hal_msp.c`: HAL库回调函数
- [x] `Core/Src/system_stm32g4xx.c`: 系统初始化
- [x] `Core/Inc/main.h`: 主程序头文件
- [x] `Core/Inc/stm32g4xx_hal_conf.h`: HAL库配置
- [x] `Drivers/STM32G4xx_HAL_Driver/`: HAL库源码 (86个.c文件, 96个.h文件)
- [x] `Drivers/CMSIS/`: CMSIS核心文件

### 2.4 启动与链接文件
- [x] `startup_stm32g431xx.s`: 启动汇编代码,中断向量表
- [x] `STM32G431XX_FLASH.ld`: 链接脚本,存储器布局定义

## 3. 构建配置文件清单

### 3.1 CMake构建系统
- [x] `CMakeLists.txt` (75行): 主构建脚本
- [x] `CMakePresets.json` (61行): 构建预设配置 (debug/release/relWithDebInfo/minSizeRel)
- [x] `cmake/gcc-arm-none-eabi.cmake` (44行): GCC工具链配置
- [x] `cmake/stm32cubemx/CMakeLists.txt`: CubeMX生成的HAL库构建脚本
- [x] `compile_commands.json`: 编译命令数据库(用于代码智能感知)

### 3.2 Keil MDK-ARM项目
- [x] `MDK-ARM/IMU_ICM42688P.uvprojx`: Keil工程文件
- [x] `MDK-ARM/IMU_ICM42688P.uvoptx`: Keil用户选项
- [x] `MDK-ARM/DebugConfig/IMU_ICM42688P_STM32G431CBUx.dbgconf`: 调试配置

## 4. 已编译二进制文件

### 4.1 调试版本
- [x] `build/debug/IMU_ICM42688P.elf`: ELF可执行文件(包含调试符号)
- [x] `build/debug/IMU_ICM42688P.map`: 链接器映射文件
- [ ] `build/debug/IMU_ICM42688P.bin`: 二进制文件(需手动生成)
- [ ] `build/debug/IMU_ICM42688P.hex`: Intel HEX文件(需手动生成)

### 4.2 发布版本
- [ ] `build/release/IMU_ICM42688P.elf`: (未编译,需要时执行)
- [ ] `build/release/IMU_ICM42688P.bin`: (未编译)

**注意**: 二进制文件通常不纳入版本控制,接收方需自行编译生成

## 5. 硬件资源清单

### 5.1 开发硬件
- [ ] **STM32G431开发板**: (请确认具体型号与数量)
- [ ] **ICM-42688P模块**: (请确认具体型号与数量)
- [ ] **ST-Link调试器**: 用于固件下载与调试
- [ ] **USB转串口模块**: 用于UART通信调试 (2个,双路UART)
- [ ] **连接线缆**: SPI线、UART线、电源线

### 5.2 测试设备
- [ ] **示波器/逻辑分析仪**: 用于信号时序分析
- [ ] **多用表**: 用于电压/电流测量
- [ ] **转台/动捕系统**: (如有)用于姿态精度测试

## 6. 开发环境要求

### 6.1 必需软件
- [ ] **ARM GCC工具链**: 版本 10.3-2021.10 或更新
- [ ] **CMake**: 版本 3.22 或更新
- [ ] **Ninja**: (可选)构建工具
- [ ] **Git**: 版本控制
- [ ] **VS Code / CLion / Keil MDK**: 集成开发环境

### 6.2 烧录调试工具
- [ ] **OpenOCD**: 开源片上调试工具
- [ ] **STM32CubeProgrammer**: ST官方烧录工具
- [ ] **ST-Link驱动**: Windows驱动程序
- [ ] **GDB**: arm-none-eabi-gdb 调试器

### 6.3 通信调试工具
- [ ] **minicom / screen**: Linux串口工具
- [ ] **串口助手**: Windows串口调试工具
- [ ] **Tera Term / PuTTY**: 跨平台终端工具

### 6.4 设计工具
- [ ] **STM32CubeMX**: 版本 6.x,用于外设配置代码生成
- [ ] **Altium Designer / KiCad**: (如有)用于查看原理图/PCB

## 7. 已知问题与待办事项

### 7.1 已知问题
- [x] **文件命名不一致**: 头文件`ICM-42688P.h`与源文件`ICM-426688P.c`命名差异
  - **影响**: 可能导致大小写敏感系统编译错误
  - **建议**: 统一修改为`ICM42688P.h`和`ICM42688P.c`

- [ ] **时间戳未同步**: `timestamp`变量无外部时间源同步
  - **影响**: 无法与其他系统进行精确时间对齐
  - **建议**: 实现PPS信号捕获或NTP同步

- [ ] **零点偏移未校准**: 当前偏移量设置为0
  - **影响**: 静态漂移未补偿,影响测量精度
  - **建议**: 执行静态标定流程,更新偏移宏定义

- [ ] **姿态解算算法未实现**: 系统仅提供原始IMU数据采集
  - **影响**: 无法直接输出姿态信息
  - **建议**: 实现姿态融合算法（如互补滤波、Kalman滤波或Madgwick算法）

### 7.2 待开发功能
- [ ] **姿态解算算法**: 实现姿态融合算法（最高优先级）
- [ ] **SD卡数据记录**: 实现高速数据记录功能
- [ ] **无线通信**: 替换UART为蓝牙/Wi-Fi模块
- [ ] **动态校准**: 实现运行时传感器校准
- [ ] **电源管理**: 实现低功耗休眠模式
- [ ] **故障检测**: 实现传感器通信失败检测与恢复
- [ ] **配置接口**: 通过UART命令动态修改参数
- [ ] **显示屏输出**: 添加OLED/TFT显示实时数据

### 7.3 优化建议
- [ ] **中断优先级优化**: 根据实际需求重新评估优先级分配
- [ ] **数据输出优化**: 改进平均算法,降低浮点舍入误差
- [ ] **代码尺寸优化**: 评估是否需要浮点printf,考虑使用整数打印
- [ ] **实时性分析**: 使用RTOS(如FreeRTOS)进行任务调度
- [ ] **异常处理**: 增加错误处理与系统恢复机制

## 8. 测试状态

### 8.1 单元测试
- [ ] **传感器通信测试**: 验证SPI读写正确性
- [ ] **数据解析测试**: 验证字节序转换正确性
- [ ] **UART通信测试**: 验证双路UART收发功能
- [ ] **中断时序测试**: 验证1kHz中断精度
- [ ] **姿态算法测试**: 验证四元数计算正确性

### 8.2 集成测试
- [ ] **静态测试**: 水平静置,验证加速度读数接近(0,0,1g)
- [ ] **旋转测试**: 各轴旋转,验证角速度响应
- [ ] **姿态估计测试**: 已知姿态下验证四元数/欧拉角精度
- [ ] **长时间测试**: 24小时连续运行稳定性测试
- [ ] **温度测试**: 不同温度下精度测试

### 8.3 性能测试
- [ ] **实时性测试**: 中断响应时间与处理时间测量
- [ ] **精度测试**: 与参考系统(转台/动捕)对比测试
- [ ] **通信带宽测试**: UART最大吞吐量测试
- [ ] **功耗测试**: 各模式下电流测量

## 9. 依赖关系

### 9.1 硬件依赖
- **MCU**: STM32G431CBUx (不可替换为其他型号,需修改配置)
- **传感器**: ICM-42688P (可替换为ICM-42688系列其他型号,需修改驱动)
- **时钟源**: 外部HSE晶振/时钟源
- **调试接口**: SWD (SWDIO/SWCLK)

### 9.2 软件依赖
- **HAL库**: STM32G4xx HAL Driver (版本兼容性需注意)
- **CMSIS**: ARM CMSIS 5.x
- **工具链**: ARM GCC (需要硬件浮点支持)

### 9.3 外部库版本
```
STM32 HAL: V1.2.x (根据CubeMX生成版本)
CMSIS: V5.x
```

## 10. 许可证与版权

### 10.1 项目代码
- **用户代码**: (请根据实际情况填写许可证)
- **STM32 HAL库**: BSD 3-Clause License (ST提供)
- **CMSIS**: Apache License 2.0

### 10.2 文档
- **技术文档**: (请根据实际情况填写)
- **数据手册**: © InvenSense (仅供参考使用)

### 10.3 第三方组件
- 项目中包含的所有第三方组件已在各自源文件头部声明许可证信息

## 11. 联系信息

### 11.1 原开发者
- **姓名**: (请填写)
- **邮箱**: (请填写)
- **电话**: (请填写)
- **工作时间**: (请填写)

### 11.2 技术支持
- **ST官方支持**: https://www.st.com/content/st_com/en/support/support-home.html
- **STM32社区**: https://community.st.com/

### 11.3 参考资源
- **STM32G4参考手册**: RM0440
- **STM32G4数据手册**: DS12766
- **ICM-42688P数据手册**: 已包含在项目中

## 12. 交接确认

### 12.1 交接方确认
- [ ] 已提供所有源代码文件
- [ ] 已提供完整技术文档
- [ ] 已提供构建配置文件
- [ ] 已说明已知问题与待办事项
- [ ] 已移交开发硬件 (如适用)
- [ ] 已进行现场演示 (如适用)
- [ ] 已提供必要的培训 (如适用)

**交接人签字**: ________________  
**交接日期**: ________________

### 12.2 接收方确认
- [ ] 已收到所有源代码文件
- [ ] 已阅读完整技术文档
- [ ] 已成功编译项目
- [ ] 已验证基本功能 (如有硬件)
- [ ] 已明确后续开发任务
- [ ] 已了解已知问题
- [ ] 对项目有清晰理解

**接收人签字**: ________________  
**接收日期**: ________________

### 12.3 交接备注
```
(请在此处添加任何额外说明、特殊注意事项或口头约定)






```

## 13. 关键寄存器速查表

| 寄存器 | 地址 | 功能 |
|--------|------|------|
| REG_BANK_SEL | 0x76 | 寄存器组选择 |
| DEVICE_CONFIG | 0x11 | 设备配置(软复位) |
| PWR_MGMT0 | 0x4E | 电源管理 |
| GYRO_CONFIG0 | 0x4F | 陀螺仪配置 |
| ACCEL_CONFIG0 | 0x50 | 加速度计配置 |
| TEMP_DATA1 | 0x1D | 温度高字节 |
| TEMP_DATA0 | 0x1E | 温度低字节 |
| ACCEL_DATA_X1 | 0x1F | 加速度X高字节(起始地址) |

## 14. 快速问题定位表

| 问题现象 | 可能原因 | 排查方法 |
|----------|----------|----------|
| 编译失败 | 工具链未安装/路径错误 | 检查`arm-none-eabi-gcc --version` |
| 烧录失败 | ST-Link连接问题 | 检查USB连接、驱动安装 |
| 串口无输出 | 波特率错误/线序错误 | 确认2Mbps波特率、TX/RX |
| IMU数据为0 | SPI通信故障 | 检查接线、片选信号 |
| 姿态不稳定 | 未校准/算法参数不当 | 执行零点校准、调整增益 |

---

**文档结束**

本文档为STM32G4 IMU-ICM42688P惯性测量单元系统的完整技术文档,包含详细技术说明、快速参考指南与项目交接清单。建议开发者首先阅读第一部分了解项目概况,然后根据需要查阅第二部分的详细技术实现,日常开发可参考第三部分的快速参考指南,项目交接时使用第四部分的交接清单进行确认。

**版权声明**: 本文档由AI助手生成,用于项目技术交接与开发参考。

